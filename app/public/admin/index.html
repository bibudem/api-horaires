<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta content="width=device-width,initial-scale=1" name="viewport">
  <title>API Horaires - Administration</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <!-- MDB -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.2.0/mdb.min.css" rel="stylesheet" />

  <!-- Font Awesome -->
  <!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"> -->
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Bootstrap core CSS -->
  <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
  <!-- Material Design Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/loadingio/ldbutton@v1.0.1/dist/ldbtn.min.css" />


  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script> -->
  <!-- MDB -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.2.0/mdb.min.js"></script>
  <style>
    .table td,
    .table th {
      font-size: inherit;
    }

    code {
      font-family: 'Roboto Mono', monospace;
      color: inherit;
      font-size: inherit;
      border-radius: 2px;
      background: #f7f7f7;
      padding: 0px 5px;
    }

    .hidden {
      display: none;
    }

    .icon {
      font-size: 2rem;
      position: relative;
      top: 8px;
    }

    .status-container {
      font-weight: bolder;
    }

    .progress {
      position: absolute;
      top: 0;
      width: 100%;
    }

    .progress-bar {
      transition: width 100ms linear;
    }
  </style>
</head>

<body>
  <div class="progress" hidden>
    <div class="progress-bar unique-color" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
  <div class="container mt-5">
    <h1>Horaires - admin</h1>
    <form class="submit-form" action="../import" method="POST">
      <p>Importe de LibCAL tous les horaires des bibliothèques et leurs services pour les 52 semaines à venir. Les jours où il n'y a pas d'horaire définit seront ignorés.</p>
      <div>
        <button class="submit-btn btn unique-color text-white my-4" type="submit">Importer les horaires<div class="ld ld-ring ld-spin"></div></button>
        <span class="spinner blue-grey-text" style="position: relative; top: 8px; display: none;">
          <div class="spinner-border" role="status"><span class="sr-only">Exécution...</span></div>
        </span>
        <i id="icon-check" class="fas fa-check blue-grey-text icon" style="display: none"></i><i id="icon-times" class="fas fa-times text-danger icon" style="display: none"></i>
        <p><span class="status-container" style="display: none"><span class="status"></span></span>&nbsp;</p>
      </div>
    </form>
    <hr>
    <h2 class="my-4">Liste des bibliothèques présentes dans l'API</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Bibliothèque</th>
        </tr>
      </thead>
      <tbody id="liste-bibs"></tbody>
    </table>
    <h2 class="my-4">Liste des types de services</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Service</th>
        </tr>
      </thead>
      <tbody id="liste-services"></tbody>
    </table>
  </div>

  <script>
    (function () {
      const decoder = new TextDecoder() // This will convert the Uint8Array of bytes into ASCII text

      function updateProgress(n = 0) {
        if (n < 1) {
          if (progress.hidden) {
            progress.hidden = false
          }
          const p = n * 100
          progressBar.setAttribute('aria-valuenow', p)
          progressBar.style.width = `${p}%`
        } else {
          progress.hidden = true
        }
      }

      function decodeMessage(value) {
        return /^(?<message>\w+):(?<data>.+)$/.exec(decoder.decode(value)).groups
      }

      function delayHide($node) {
        if ($node.data('handle')) {
          clearInterval($node.data('handle'))
          $node.data('handle', null)
        }
        return setTimeout(function () {
          $node.fadeOut()
        }, 5000)
      }

      const submitForm = document.querySelector('.submit-form')
      const submitBtn = document.querySelector('.submit-btn')
      const progress = document.querySelector('.progress')
      const progressBar = progress.querySelector('.progress-bar')
      /*    $spinner = $('.spinner'),
          $statusContainer = $('.status-container'),
          $status = $('.status'),
          $iconCheck = $('#icon-check'),
          $iconTimes = $('#icon-times'),
          statusContainerHandle;*/

      submitForm.addEventListener('submit', async event => {
        event.preventDefault()

        if (submitBtn.disabled) {
          return
        }

        const response = await fetch(submitForm.action, { method: submitForm.method })
        const reader = response.body.getReader(); // get the response stream
        let progressState = 'inprogress'
        let resultData = ''

        // Loop indefinitely while the response comes in (I don't think this is blocking)
        while (true) {
          const { done, value } = await reader.read(); // value will be the byes of the latest response
          if (done) {
            console.log('done: ', decoder.decode(value))
            break; // exit the loop
          }

          if (progressState === 'completed') {
            console.log('### completed: ', decoder.decode(value))
            resultData += decoder.decode(value)
          } else {

            const { message, data } = decodeMessage(value)

            if (message === 'result') {
              console.log('### finished')
              progressState = 'completed'
              resultData += data
              updateProgress(1)
            } else {
              console.log('message: %s', message)
              console.log('data: %s', data)
              const progress = Math.trunc(parseFloat(data) * 1E4) / 1E4
              updateProgress(progress)
              // Use the text returned by the server
              console.log(`progress: %s`, progress);
            }
          }
        }
        // After the response is done
        if (response.ok) {
          console.log(resultData)
          const result = JSON.parse(resultData)
          console.log(`Done! %o`, result)
        }
      })
      /*
            $('form').on('submit', function (e) {
              return
              e.preventDefault();
      
              $status.empty().removeClass('text-success');
              $iconCheck.hide();
              $iconTimes.hide();
              // $spinner.show();
              submitBtn.classList.add('running')
      
              $statusContainer.show();
      
              if ($statusContainer.data('handle')) {
                clearTimeout($statusContainer.data('handle'))
                $statusContainer.data('handle', null)
              }
      
              $.ajax({
                method: this.method,
                url: this.action
              })
                .then(function (data, status) {
                  $status.text(data.nbRows + ' horaires importés.')
                  $iconCheck.show()
                  delayHide($iconCheck)
                  delayHide($statusContainer)
                })
                .catch(function (data) {
                  data = data.responseJSON;
      
                  $status
                    //.addClass('text-success')
                    .html(data.nbRows + ' horaires importés. <span class="text-danger">' + data.errorMessages.join(' ') + '</span>')
                  $iconTimes.show()
                  delayHide($iconTimes)
                })
                .always(function () {
                  $spinner.hide();
                })
            })*/

      // Liste des bibliothèques

      fetch('../liste')
        .then(response => response.json())
        .then(data => {
          const listeBibs = document.querySelector('#liste-bibs')
          for (const key in data) {
            const bib = data[key]
            const tr = document.createElement('tr')
            tr.innerHTML = '<td><code>' + key + '</code></td><td>' + bib + '</td>'
            listeBibs.append(tr)
          }
        })

      // Liste des 

      fetch('../services')
        .then(response => response.json())
        .then(data => {
          const listeServices = document.querySelector('#liste-services')
          for (const key in data) {
            const service = data[key]
            const tr = document.createElement('tr')
            tr.innerHTML = '<td><code>' + key + '</code></td><td>' + service.label + '</td>'
            listeServices.append(tr)
          }
        })
    })()
  </script>
</body>

</html>